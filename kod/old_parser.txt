namespaces = {
    'm': 'istp:opendata:schemas:MereniSeznam:v1', 
    'd': 'istp:opendata:schemas:DatovaSada:v1'      
}

xml_file = Path(r'kod\data\priklady\data_z_mericich_pristoroju\Data z měřících přístrojů 28-08-2021.xml')
tree = etree.parse(xml_file)
datovy_obsah = tree.find('d:DatovyObsah', namespaces)
mereni_seznam_element = datovy_obsah[0]


def safe_get(element, xpath, namespaces):
    if element is None:
        return None
    node = element.find(xpath, namespaces)
    return node.text if node is not None else None


def safe_find(element, xpath, namespaces):
    if element is None:
        return None
    return element.find(xpath, namespaces)


def safe_findall(element, xpath, namespaces):
    if element is None:
        return None
    return element.findall(xpath, namespaces)


def safe_get_attribute(element, attribute_name):
    if element is None:
        return None
    return element.get(attribute_name)


def safe_index(list, index):
    try:
        return list[index]
    except (TypeError, IndexError):
        return None


def get_poznamky(element, namespaces):
    poznamky = safe_findall(element, 'm:poznamka', namespaces)
    if poznamky is None:
        return None
    return '\n'.join(p.text for p in poznamky)


def get_result_attributes(element, prefix):
    return {
        f'{prefix}_Hodnota': safe_get_attribute(element, 'hodnota'),
        f'{prefix}_Vysledek': safe_get_attribute(element, 'vysledek')
    }


def get_boundary_attributes(element, prefix):
    return {
        f'{prefix}_Hodnota': safe_get_attribute(element, 'hodnota'),
        f'{prefix}_RucniZadani': safe_get_attribute(element, 'rucniZadani')
    }


def get_measured(element, prefix, namespaces):
    min = safe_find(element, 'm:min', namespaces)
    max = safe_find(element, 'm:max', namespaces)

    attributes = get_result_attributes(element, prefix)
    min_attributes = get_boundary_attributes(min, f'{prefix}_Min')
    max_attributes = get_boundary_attributes(max, f'{prefix}_Max')
    
    return attributes | min_attributes | max_attributes
    


def get_monitor_attributes(element, prefix):
    return {
        f'{prefix}_Podporovano': safe_get_attribute(element, 'podporovano'),
        f'{prefix}_Otestovano': safe_get_attribute(element, 'otestovano')
    }


def get_otacky_benzin(element, prefix, namespaces):
    measured_list = ['CO', 'CO2', 'COCOOR', 'HC', 'LAMBDA', 'N', 'NOX', 'O2', 'TPS']
    return {key: value for measured in measured_list for key, value in get_measured(safe_find(element, f'm:{measured}', namespaces), f'{prefix}_{measured}', namespaces).items()}


def get_mereni_nafta(element, prefix, namespaces):
    measured_list = [('Tps', 'TPS'), ('CasAkcelerace', 'casAkcelerace'), ('Kourivost', 'kourivost'), ('OtackyPrebehove', 'otackyPrebehove'), ('OtackyVolnobezne', 'otackyVolnobezne'), ('Teplota', 'teplota'), ('TlakKomory', 'tlakKomory'), ('TeplotaKomory', 'teplotaKomory')]
    return {key: value for col_name, element_name in measured_list for key, value in get_measured(safe_find(element, f'm:{element_name}', namespaces), f'{prefix}_{col_name}', namespaces).items()}


def get_detail_benzin(element, prefix, namespaces):
    result = {}
    result[f'{prefix}_Palivo'] = safe_get_attribute(element, 'palivo')
    benzin_vyusteni_element_list = safe_findall(element, 'm:vyusteni', namespaces)
    for i in range(4):
        benzin_vyusteni_element = safe_index(benzin_vyusteni_element_list, i)
        result.update(get_otacky_benzin(safe_find(benzin_vyusteni_element, 'm:otackyVolnobezne', namespaces), f'{prefix}_Vyusteni{i}_OtackyVolnobezne', namespaces))
        result.update(get_otacky_benzin(safe_find(benzin_vyusteni_element, 'm:otackyZvysene', namespaces), f'{prefix}_Vyusteni{i}_OtackyZvysene', namespaces))
    return result


def get_detail_nafta(element, namespaces):
    result = {}
    result['Nafta_Palivo'] = safe_get_attribute(element, 'palivo')

    mereni_vznet_limit_element = safe_find(element, 'm:mereniVznetLimit', namespaces)
    limits_list = [('Tps', 'TPS'), ('CasAkcelerace', 'casAkcelerace'), ('Kourivost', 'kourivost'), ('KourivostRozpeti', 'kourivostRozpeti'), ('OtackyPrebehove', 'otackyPrebehove'), ('OtackyVolnobezne', 'otackyVolnobezne')]
    for col_name, element_name in limits_list:
        limit_element = safe_find(mereni_vznet_limit_element, f'm:{element_name}', namespaces)
        result.update(get_boundary_attributes(safe_find(limit_element, 'm:min', namespaces), f'Nafta_{col_name}_Min'))
        result.update(get_boundary_attributes(safe_find(limit_element, 'm:max', namespaces), f'Nafta_{col_name}_Max'))

    nafta_vyusteni_element_list = safe_findall(element, 'm:vyusteni', namespaces)
    for i in range(4):
        nafta_vyusteni_element = safe_index(nafta_vyusteni_element_list, i)
        nafta_mereni_prumer_element = safe_find(nafta_vyusteni_element, 'm:mereniPrumer', namespaces)
        result.update(get_mereni_nafta(nafta_mereni_prumer_element, f'Nafta_Vyusteni{i}_MereniPrumer', namespaces))
        nafta_mereni_element_list = safe_findall(nafta_vyusteni_element, 'm:mereni', namespaces)
        for j in range(4):
            nafta_mereni_element = safe_index(nafta_mereni_element_list, j)
            result.update(get_mereni_nafta(nafta_mereni_element, f'Nafta_Vyusteni{i}_Mereni{j}', namespaces))

    return result
    
def get_detail_plyn(element, namespaces):
    result = get_detail_benzin(element, 'Plyn', namespaces)

    nadrz_plyn_element = safe_find(safe_find(element, 'm:kontrolaNadrzi', namespaces), 'm:nadrz', namespaces)
    result['Plyn_Nadrz_Vyrobce'] = safe_get_attribute(nadrz_plyn_element, 'vyrobce')
    result['Plyn_Nadrz_Homologace'] = safe_get_attribute(nadrz_plyn_element, 'homologace')
    result['Plyn_Nadrz_Zivotnost'] = safe_get_attribute(nadrz_plyn_element, 'zivotnost')
    result['Plyn_Nadrz_Kontrola'] = safe_get_attribute(nadrz_plyn_element, 'kontrola')

    return result


mereni1 = mereni_seznam_element[1]






emise_record = {}
emise_record['CisloProtokolu'] = safe_get(mereni1, 'm:CisloProtokolu', namespaces)
emise_record['DatumProhlidky'] = safe_get(mereni1, 'm:DatumProhlidky', namespaces)
emise_record['StaniceCislo'] = safe_get(safe_find(mereni1, 'm:Stanice', namespaces), 'm:Cislo', namespaces)
emise_record['Zahajeni'] = safe_get(safe_find(mereni1, 'm:CasoveUdaje', namespaces), 'm:Zahajeni', namespaces)
emise_record['Ukonceni'] = safe_get(safe_find(mereni1, 'm:CasoveUdaje', namespaces), 'm:Ukonceni', namespaces)
emise_record['OdpovednaOsoba'] = safe_get(mereni1, 'm:OdpovednaOsoba', namespaces)

pristroj_data_element = safe_find(mereni1, 'm:PristrojData', namespaces)
prohlidka_element = safe_find(pristroj_data_element, 'm:prohlidka', namespaces)
emise_record['Prohlidka_CisloProtokolu'] = safe_get_attribute(prohlidka_element, 'cisloProtokolu')
emise_record['Prohlidka_DatumProhlidky'] = safe_get_attribute(prohlidka_element, 'datumProhlidky')

merici_pristroj_element = safe_find(prohlidka_element, 'm:mericiPristroj', namespaces)
emise_record['MericiPristroj_Vyrobce'] = safe_get_attribute(merici_pristroj_element, 'vyrobce')
emise_record['MericiPristroj_Typ'] = safe_get_attribute(merici_pristroj_element, 'typ')
emise_record['MericiPristroj_Verze'] = safe_get_attribute(merici_pristroj_element, 'verze')
emise_record['MericiPristroj_OBD'] = safe_get_attribute(merici_pristroj_element, 'OBD')
emise_record['MericiPristroj_VerzeSoftware'] = safe_get_attribute(merici_pristroj_element, 'verzeSoftware')

emise_record['Poznamky'] = get_poznamky(prohlidka_element, namespaces)

vozidlo_element = safe_find(pristroj_data_element, 'm:vozidlo', namespaces)
emise_record['Vozidlo_Vin'] = safe_get(vozidlo_element, 'm:VIN', namespaces)
emise_record['Vozidlo_Znacka'] = safe_get(vozidlo_element, 'm:tovazniZnacka', namespaces)
emise_record['Vozidlo_ObchodniOznaceni'] = safe_get(vozidlo_element, 'm:typVozidla', namespaces)
emise_record['Vozidlo_TypMotoru'] = safe_get(vozidlo_element, 'm:typMotoru', namespaces)
emise_record['Vozidlo_CisloMotoru'] = safe_get(vozidlo_element, 'm:cisloMotoru', namespaces)
emise_record['Vozidlo_Odometer'] = safe_get(vozidlo_element, 'm:stavTachometru', namespaces)
emise_record['Vozidlo_RokVyroby'] = safe_get(vozidlo_element, 'm:rokVyroby', namespaces)
emise_record['Vozidlo_DatumPrvniRegistrace'] = safe_get(vozidlo_element, 'm:datumPrvniRegistrace', namespaces)
emise_record['Vozidlo_Palivo'] = safe_get(vozidlo_element, 'm:palivo', namespaces)

vysledek_mereni_element = safe_find(pristroj_data_element, 'm:vysledekMereni', namespaces)
emise_record['Vysledek_VisualniKontrola'] = safe_get_attribute(vysledek_mereni_element, 'vysledekVisualniKontroly')
emise_record['Vysledek_Readiness'] = safe_get_attribute(vysledek_mereni_element, 'vysledekReadiness')
emise_record['Vysledek_RidiciJednotka'] = safe_get_attribute(vysledek_mereni_element, 'vysledekRidiciJednotka')
emise_record['Vysledek_RidiciJednotkaStav'] = safe_get_attribute(vysledek_mereni_element, 'vysledekRidiciJednotkaStav')
emise_record['Vysledek_Mil'] = safe_get_attribute(vysledek_mereni_element, 'vysledekMIL')
emise_record['Vysledek_TesnostPlynovehoZarizeni'] = safe_get_attribute(vysledek_mereni_element, 'vysledekTesnostPlynovehoZarizeni')

vyhovuje_element = safe_find(vysledek_mereni_element, 'm:vyhovuje', namespaces)
emise_record['Vysledek_Vyhovuje'] = 'true' if vyhovuje_element is not None else None
emise_record['PristiProhlidka'] = safe_get_attribute(vyhovuje_element, 'pristiProhlidka')

emisni_system_element = safe_find(pristroj_data_element, 'm:emisniSystem', namespaces)
rizeny_obd_element = safe_find(emisni_system_element, 'm:rizenyOBD', namespaces)
rizeny_element = safe_find(emisni_system_element, 'm:rizeny', namespaces)
nerizeny_element = safe_find(emisni_system_element, 'm:nerizeny', namespaces)
emise_record['EmisniSystem'] = "Rizeny_Obd" if rizeny_obd_element is not None else "Rizeny" if rizeny_element is not None else "Nerizeny" if nerizeny_element is not None else None
emise_record['Obd_KomunikacniProtokol'] = safe_get(rizeny_obd_element, 'm:komunikacniProtokol', namespaces)
emise_record['Obd_Vin'] = safe_get(rizeny_obd_element, 'm:VIN', namespaces)
emise_record['Obd_PocetDtc'] = safe_get(rizeny_obd_element, 'm:pocetDTC', namespaces) if not None else safe_get(rizeny_element, 'm:pocetDTC', namespaces)
emise_record['Obd_VzdalenostDtc'] = safe_get(rizeny_obd_element, 'm:vzdalenostDTC', namespaces)
emise_record['Obd_CasDtc'] = safe_get(rizeny_obd_element, 'm:casDTC', namespaces)
emise_record['Obd_KontrolaMil'] = safe_get(rizeny_obd_element, 'm:kontrolaMIL', namespaces)

readiness_element = safe_find(rizeny_obd_element, 'm:readiness', namespaces)
emise_record['Obd_Readiness_Vysledek'] = safe_get_attribute(readiness_element, 'vysledek')

all_monitors = [
    ('Zazeh', 'OBDzazeh', ['AC', 'CAT-FUNC', 'COMP', 'EGR-VVT', 'EVAP', 'FUEL', 'HCAT', 'MISF', 'O2S-FUNC', 'O2S-HEAT', 'SAS']),
    ('Vznet', 'OBDvznet', ['AC', 'BOOST', 'COMP', 'DPF', 'EGR-VVT', 'EGS', 'FUEL', 'MISF', 'NMHC', 'NOX', 'RESERVE']),
    ('J1939', 'J1939', ['AC', 'BOOST', 'CAT-FUNC', 'COLD', 'COMP', 'DPF', 'EGR-VVT', 'EGS-FUNC', 'EGS-HEAT', 'EVAP', 'FUEL', 'HCAT', 'MISF', 'NM-HC', 'NOX', 'SAS'])
]
for col_name, element_name, monitor_list in all_monitors:
    parent = safe_find(readiness_element, f'm:{element_name}', namespaces)
    prefix = f'Obd_Readiness_{col_name}'
    emise_record.update({key: value for monitor in monitor_list for key, value in get_monitor_attributes(safe_find(parent, f'm:{monitor}', namespaces), f'{prefix}_{monitor}').items()})

detail_benzin_element = safe_find(pristroj_data_element, 'm:detailBenzin', namespaces)
emise_record.update(get_detail_benzin(detail_benzin_element, 'Benzin', namespaces))

detail_nafta_element = safe_find(pristroj_data_element, 'm:detailNafta', namespaces)
emise_record.update(get_detail_nafta(detail_benzin_element, namespaces))

detail_plyn_element = safe_find(pristroj_data_element, 'm:detailPlyn', namespaces)
emise_record.update(get_detail_plyn(detail_plyn_element, namespaces))

display(emise_record)